name: Build Semeru JRE Nanos Package ARM64

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  SEMERU_VERSION: "25.0.1"
  OPENJ9_VERSION: "0.56.0"
  PACKAGE_NAME: "SemeruJDKarm64Linux"

jobs:
  build-arm64-package:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Install QEMU (user-mode + static)
    - name: Install QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu qemu-user qemu-user-static

    # Install system utilities
    - name: Install system utilities
      run: |
        sudo apt-get install -y wget tar unzip
    - name: Ensure QEMU binaries are in PATH
      run: |
        mkdir -p $HOME/.ops/bin
        cp /usr/bin/qemu-aarch64-static $HOME/.ops/bin/qemu-aarch64
        chmod +x $HOME/.ops/bin/qemu-aarch64
         # Controllo se il binario Ã¨ accessibile
        echo "QEMU aarch64 path: $(which qemu-aarch64 || echo 'Not found')"
    
        # Versione QEMU
        qemu-aarch64 --version

    - name: Verify QEMU for ops
      run: |
        $HOME/.ops/bin/qemu-aarch64 --version
            
    # Install ops
    - name: Install ops (NanoVMs)
      run: |
        export OPS_INSTALL_QEMU=0
        curl -L https://ops.city/get.sh | sh

    # Add ops to PATH
    - name: Add ops to PATH
      run: |
        echo "$HOME/.ops/bin" >> $GITHUB_PATH

    # Verify ops installation
    - name: Verify ops installation
      run: |
        qemu-aarch64 --version 
        ops version

    # Create package structure
    - name: Create package structure
      run: |
        mkdir -p ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/sysroot/{lib64,usr/lib/aarch64-linux-gnu}
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}
        echo "Package structure created with lib64 and usr/lib/aarch64-linux-gnu"

    # Download Semeru JRE ARM64
    - name: Download Semeru JRE ARM64
      run: |
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/sysroot
        wget -q --show-progress \
          https://github.com/ibmruntimes/semeru25-binaries/releases/download/jdk-${{ env.SEMERU_VERSION }}%2B8_openj9-${{ env.OPENJ9_VERSION }}/ibm-semeru-open-jdk_aarch64_linux_${{ env.SEMERU_VERSION }}_8_openj9-${{ env.OPENJ9_VERSION }}.tar.gz
        tar xzf ibm-semeru-open-jdk_aarch64_linux_${{ env.SEMERU_VERSION }}_8_openj9-${{ env.OPENJ9_VERSION }}.tar.gz
        rm ibm-semeru-open-jdk_aarch64_linux_${{ env.SEMERU_VERSION }}_8_openj9-${{ env.OPENJ9_VERSION }}.tar.gz

    # Extract ARM64 system libraries
    - name: Extract ARM64 system libraries
      run: |
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/sysroot
        LINKER=$(find /lib* -name 'ld-linux-aarch64.so.1' 2>/dev/null | head -1)
        cp "$LINKER" lib64/
        cp /lib/aarch64-linux-gnu/libc.so.6 usr/lib/aarch64-linux-gnu/
        cp /lib/aarch64-linux-gnu/libm.so.6 usr/lib/aarch64-linux-gnu/
        cp /lib/aarch64-linux-gnu/libpthread.so.0 usr/lib/aarch64-linux-gnu/
        cp /lib/aarch64-linux-gnu/libdl.so.2 usr/lib/aarch64-linux-gnu/
        cp /lib/aarch64-linux-gnu/librt.so.1 usr/lib/aarch64-linux-gnu/
        cp /lib/aarch64-linux-gnu/libgcc_s.so.1 usr/lib/aarch64-linux-gnu/
        cp /usr/lib/aarch64-linux-gnu/libstdc++.so.6 usr/lib/aarch64-linux-gnu/
        cp /usr/lib/aarch64-linux-gnu/libz.so.1 usr/lib/aarch64-linux-gnu/

    # Verify Java runtime (minimal)
    - name: Verify Java runtime
      run: |
        ops run \
          --package "AngeloRubens/SemeruJREx64Linux:25.0.1" \
          --nightly \
          --command java

    # Create tarball
    - name: Create tarball
      run: |
        tar czf ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz \
          ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/
        ls -lh ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz

    # Generate checksum
    - name: Generate checksum
      run: |
        sha256sum ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz > \
          ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz.sha256
        cat ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz.sha256

    # Upload artifacts
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}
        path: |
          ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz
          ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz.sha256
        retention-days: 30
