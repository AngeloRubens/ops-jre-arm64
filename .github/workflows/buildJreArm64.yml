name: Build ARM64 JRE Package (Nanos)

on:
  workflow_dispatch:

env:
  VERSION: 25.0.1
  PACKAGE_BASENAME: TemurinJREarm64Linux
  JRE_DIR: jdk-25.0.1+8-jre
  JRE_URL: https://github.com/adoptium/temurin25-binaries/releases/download/jdk-25.0.1%2B8/OpenJDK25U-jre_aarch64_linux_hotspot_25.0.1_8.tar.gz

jobs:
  build-arm64-package:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system qemu-user qemu-user-static wget tar

      - name: Install ops (NanoVMs)
        run: |
          curl -L https://ops.city/get.sh | sh

      - name: Add ops to PATH
        run: |
          echo "$HOME/.ops/bin" >> $GITHUB_PATH

      - name: Verify ops installation
        run: |
          ops version

      # ============================
      # Build package root directory
      # ============================
      - name: Prepare package root
        run: |
          export PKG_NAME=${PACKAGE_BASENAME}_${VERSION}
          mkdir -p ${PKG_NAME}/sysroot

          # ----------------------------
          # Populate Linux ARM64 sysroot
          # ----------------------------
          docker run --rm --platform linux/arm64 \
            -v $(pwd)/${PKG_NAME}/sysroot:/work \
            ubuntu:22.04 bash -c "
              set -e
              apt-get update -qq
              apt-get install -y -qq libc6 libstdc++6 zlib1g
              mkdir -p /work/lib /work/lib64 /work/usr/lib/aarch64-linux-gnu
              cp /lib/ld-linux-aarch64.so.1 /work/lib/
              cp /lib/ld-linux-aarch64.so.1 /work/lib64/
              cp /lib/aarch64-linux-gnu/libc.so.6 /work/usr/lib/aarch64-linux-gnu/
              cp /lib/aarch64-linux-gnu/libm.so.6 /work/usr/lib/aarch64-linux-gnu/
              cp /lib/aarch64-linux-gnu/libpthread.so.0 /work/usr/lib/aarch64-linux-gnu/
              cp /lib/aarch64-linux-gnu/libdl.so.2 /work/usr/lib/aarch64-linux-gnu/
              cp /lib/aarch64-linux-gnu/librt.so.1 /work/usr/lib/aarch64-linux-gnu/
              cp /lib/aarch64-linux-gnu/libgcc_s.so.1 /work/usr/lib/aarch64-linux-gnu/
              cp /usr/lib/aarch64-linux-gnu/libstdc++.so.6 /work/usr/lib/aarch64-linux-gnu/
              cp /usr/lib/aarch64-linux-gnu/libz.so.1 /work/usr/lib/aarch64-linux-gnu/
            "

          # ----------------------------
          # Install Temurin JRE in sysroot
          # ----------------------------
          cd ${PKG_NAME}/sysroot
          wget -O jre.tar.gz ${JRE_URL}
          mkdir -p ${JRE_DIR}
          tar -xzf jre.tar.gz --strip-components=1 -C ${JRE_DIR}
          rm jre.tar.gz
          cd ../..

      # ============================
      # package.manifest (JSON)
      # ============================
      - name: Create package.manifest
        run: |
          export PKG_NAME=${PACKAGE_BASENAME}_${VERSION}
          cat > ${PKG_NAME}/package.manifest <<EOF
          {
            "Program": "/${JRE_DIR}/bin/java",
            "Args": ["java"],
            "Env": {
              "JAVA_HOME": "/${JRE_DIR}"
            },
            "Version": "${VERSION}"
          }
          EOF

      - name: Create README
        run: |
          export PKG_NAME=${PACKAGE_BASENAME}_${VERSION}
          echo "Temurin JRE ${VERSION} aarch64 Linux package for Nanos VM" > ${PKG_NAME}/README.md

      # ============================
      # Test (disabled by design)
      # ============================
      - name: Test package with ops (minimal)
        if: false
        run: |
          ops pkg load TemurinJREarm64Linux_${VERSION}

      # ============================
      # Create tarball
      # ============================
      - name: Create tarball & checksum
        run: |
          export PKG_NAME=${PACKAGE_BASENAME}_${VERSION}
          tar czf ${PKG_NAME}.tar.gz ${PKG_NAME}
          sha256sum ${PKG_NAME}.tar.gz > ${PKG_NAME}.tar.gz.sha256
          cat ${PKG_NAME}.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: TemurinJREarm64Linux_${{ env.VERSION }}
          path: |
            TemurinJREarm64Linux_${{ env.VERSION }}.tar.gz
            TemurinJREarm64Linux_${{ env.VERSION }}.tar.gz.sha256
          retention-days: 30
