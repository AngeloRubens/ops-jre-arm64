name: Build Semeru JRE Nanos Package ARM64

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  SEMERU_VERSION: "25.0.1"
  OPENJ9_VERSION: "0.49.0"
  PACKAGE_NAME: "SemeruJREarm64Linux"

jobs:
  build-arm64-package:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up QEMU for ARM64
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Install tools
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y tree wget

    - name: Create package structure
      run: |
        mkdir -p ${PACKAGE_NAME}_${SEMERU_VERSION}/sysroot/{lib64,usr/lib/aarch64-linux-gnu}
        cd ${PACKAGE_NAME}_${SEMERU_VERSION}
        echo "Package structure created"

    - name: Create package.manifest
      run: |
        cd ${PACKAGE_NAME}_${SEMERU_VERSION}
        cat > package.manifest << EOF
        {
          "Program": "/jdk-${SEMERU_VERSION}+8-jre/bin/java",
          "Args": ["-version"],
          "Env": {
            "JAVA_HOME": "/jdk-${SEMERU_VERSION}+8-jre"
          },
          "Version": "${SEMERU_VERSION}"
        }
        EOF
        cat package.manifest

    - name: Create README.md
      run: |
        cd ${PACKAGE_NAME}_${SEMERU_VERSION}
        cat > README.md << EOF
        # IBM Semeru JRE ${SEMERU_VERSION} for Nanos Unikernel (ARM64)

        IBM Semeru OpenJ9 JRE packaged for NanoVMs Nanos unikernel.

        ## Architecture
        - linux/arm64 (aarch64)
        - Dynamic linker: ld-linux-aarch64.so.1

        ## Build info
        - OpenJ9: ${OPENJ9_VERSION}
        - Built on: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - Repository: ${GITHUB_REPOSITORY}
        EOF

    - name: Download Semeru JRE ARM64
      run: |
        cd ${PACKAGE_NAME}_${SEMERU_VERSION}/sysroot
        wget -q --show-progress \
          https://github.com/ibmruntimes/semeru25-binaries/releases/download/jdk-${SEMERU_VERSION}%2B8_openj9-${OPENJ9_VERSION}/ibm-semeru-open-jre_aarch64_linux_${SEMERU_VERSION}_8_openj9-${OPENJ9_VERSION}.tar.gz

        tar xzf ibm-semeru-open-jre_aarch64_linux_${SEMERU_VERSION}_8_openj9-${OPENJ9_VERSION}.tar.gz
        rm ibm-semeru-open-jre_aarch64_linux_${SEMERU_VERSION}_8_openj9-${OPENJ9_VERSION}.tar.gz

    - name: Extract ARM64 system libraries
      run: |
        cd ${PACKAGE_NAME}_${SEMERU_VERSION}/sysroot

        docker run --rm \
          --platform linux/arm64 \
          -v $(pwd):/work \
          ubuntu:22.04 bash -c "
            set -e
            apt-get update -qq
            apt-get install -y -qq libc6 libstdc++6 zlib1g

            LINKER=\$(find /lib* -name 'ld-linux-aarch64.so.1' | head -1)
            cp \$LINKER /work/lib64/

            cp /lib/aarch64-linux-gnu/libc.so.6 /work/usr/lib/aarch64-linux-gnu/
            cp /lib/aarch64-linux-gnu/libm.so.6 /work/usr/lib/aarch64-linux-gnu/
            cp /lib/aarch64-linux-gnu/libpthread.so.0 /work/usr/lib/aarch64-linux-gnu/
            cp /lib/aarch64-linux-gnu/libdl.so.2 /work/usr/lib/aarch64-linux-gnu/
            cp /lib/aarch64-linux-gnu/librt.so.1 /work/usr/lib/aarch64-linux-gnu/
            cp /lib/aarch64-linux-gnu/libgcc_s.so.1 /work/usr/lib/aarch64-linux-gnu/
            cp /usr/lib/aarch64-linux-gnu/libstdc++.so.6 /work/usr/lib/aarch64-linux-gnu/
            cp /usr/lib/aarch64-linux-gnu/libz.so.1 /work/usr/lib/aarch64-linux-gnu/
          "

    - name: Verify package structure
      run: |
        cd ${PACKAGE_NAME}_${SEMERU_VERSION}
        tree -L 4
        file sysroot/jdk-${SEMERU_VERSION}+8-jre/bin/java
        file sysroot/lib64/ld-linux-aarch64.so.1

    - name: Install ops CLI
      run: |
        curl -sSfL https://ops.city/get.sh | sudo sh
        ops version

    - name: Load package into ops
      run: |
        cd ${PACKAGE_NAME}_${SEMERU_VERSION}
        ops pkg add . -n ${PACKAGE_NAME}_${SEMERU_VERSION}
        ops pkg list

    - name: Verify java execution with ops (ARM64)
      run: |
        cat > config.json << EOF
        {
          "Program": "/jdk-${SEMERU_VERSION}+8-jre/bin/java",
          "Args": ["-version"],
          "Env": {
            "JAVA_HOME": "/jdk-${SEMERU_VERSION}+8-jre"
          },
          "RunConfig": {
            "Memory": "256m"
          }
        }
        EOF

        timeout 60 ops run -c config.json || {
          echo "ERROR: java did not start correctly"
          exit 1
        }

    - name: Create tarball
      run: |
        tar czf ${PACKAGE_NAME}_${SEMERU_VERSION}.tar.gz \
          ${PACKAGE_NAME}_${SEMERU_VERSION}

    - name: Generate checksums
      run: |
        sha256sum ${PACKAGE_NAME}_${SEMERU_VERSION}.tar.gz > \
          ${PACKAGE_NAME}_${SEMERU_VERSION}.tar.gz.sha256

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${PACKAGE_NAME}_${SEMERU_VERSION}
        path: |
          ${PACKAGE_NAME}_${SEMERU_VERSION}.tar.gz
          ${PACKAGE_NAME}_${SEMERU_VERSION}.tar.gz.sha256
