name: Build Semeru JRE Nanos Package ARM64

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  SEMERU_VERSION: "25.0.1"
  OPENJ9_VERSION: "0.56.0"
  PACKAGE_NAME: "SemeruJDKarm64Linux"

jobs:
  build-arm64-package:
    runs-on: ubuntu-22.04
    
    steps:
    # 1Ô∏è‚É£ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Install QEMU (user-mode + static)
    - name: Install QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu qemu-user qemu-user-static

    # 3Ô∏è‚É£ Install system utilities
    - name: Install system utilities
      run: |
        sudo apt-get install -y qemu-system unzip wget tar tree

    # 4Ô∏è‚É£ Install ops CLI
    - name: Install ops (NanoVMs)
      run: |
        curl -L https://ops.city/get.sh | sh

    - name: Add ops to PATH
      run: |
        echo "$HOME/.ops/bin" >> $GITHUB_PATH

    - name: Verify ops installation
      run: |
        ops version

    # 5Ô∏è‚É£ Create package structure
    - name: Create package structure
      run: |
        mkdir -p ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/sysroot/usr/lib/aarch64-linux-gnu
        mkdir -p ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/sysroot/lib64
        echo "Package structure created"

    # 6Ô∏è‚É£ Download IBM Semeru JDK ARM64
    - name: Download Semeru JDK ARM64
      run: |
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/sysroot
        wget -q --show-progress \
          https://github.com/ibmruntimes/semeru25-binaries/releases/download/jdk-${{ env.SEMERU_VERSION }}%2B8_openj9-${{ env.OPENJ9_VERSION }}/ibm-semeru-open-jdk_aarch64_linux_${{ env.SEMERU_VERSION }}_8_openj9-${{ env.OPENJ9_VERSION }}.tar.gz
        tar xzf ibm-semeru-open-jdk_aarch64_linux_${{ env.SEMERU_VERSION }}_8_openj9-${{ env.OPENJ9_VERSION }}.tar.gz
        rm ibm-semeru-open-jdk_aarch64_linux_${{ env.SEMERU_VERSION }}_8_openj9-${{ env.OPENJ9_VERSION }}.tar.gz

    # 7Ô∏è‚É£ Extract ARM64 system libraries + linker
    - name: Extract ARM64 system libraries
      run: |
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/sysroot
        docker run --rm --platform linux/arm64 -v $(pwd):/work ubuntu:22.04 bash -c "
          set -e
          apt-get update -qq
          apt-get install -y -qq libc6 libstdc++6 zlib1g
          
          mkdir -p /work/lib64 /work/usr/lib/aarch64-linux-gnu
          cp /lib/ld-linux-aarch64.so.1 /work/lib64/
          cp /lib/aarch64-linux-gnu/libc.so.6 /work/usr/lib/aarch64-linux-gnu/
          cp /lib/aarch64-linux-gnu/libm.so.6 /work/usr/lib/aarch64-linux-gnu/
          cp /lib/aarch64-linux-gnu/libpthread.so.0 /work/usr/lib/aarch64-linux-gnu/
          cp /lib/aarch64-linux-gnu/libdl.so.2 /work/usr/lib/aarch64-linux-gnu/
          cp /lib/aarch64-linux-gnu/librt.so.1 /work/usr/lib/aarch64-linux-gnu/
          cp /lib/aarch64-linux-gnu/libgcc_s.so.1 /work/usr/lib/aarch64-linux-gnu/
          cp /usr/lib/aarch64-linux-gnu/libstdc++.so.6 /work/usr/lib/aarch64-linux-gnu/
          cp /usr/lib/aarch64-linux-gnu/libz.so.1 /work/usr/lib/aarch64-linux-gnu/
        "

    # 8Ô∏è‚É£ Create package.manifest (directory superiore a sysroot)
    - name: Create package.manifest
      run: |
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}
        cat > package.manifest << 'EOF'
           {
            "Program": "jdk-25.0.1+8-openj9/bin/java",
            "Args": ["java"],
            "Env": {
              "JAVA_HOME": "jdk-25.0.1+8-openj9"
            },
            "Version": "25.0.1"
           }
        EOF
        cat package.manifest

    # 9Ô∏è‚É£ Create README.md
    - name: Create README.md
      run: |
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}
        cat > README.md << 'EOF'
        # IBM Semeru JDK ${{ env.SEMERU_VERSION }} for Nanos Unikernel (ARM64)

        Package contains IBM Semeru JDK ARM64 + system libraries for Nanos unikernel.

        ## Structure
        ```
        sysroot/
        ‚îú‚îÄ‚îÄ lib64/
        ‚îÇ   ‚îî‚îÄ‚îÄ ld-linux-aarch64.so.1
        ‚îú‚îÄ‚îÄ usr/
        ‚îÇ   ‚îî‚îÄ‚îÄ lib/aarch64-linux-gnu/
        ‚îÇ       ‚îú‚îÄ‚îÄ libc.so.6
        ‚îÇ       ‚îú‚îÄ‚îÄ libm.so.6
        ‚îÇ       ‚îî‚îÄ‚îÄ ...
        ‚îî‚îÄ‚îÄ jdk-${{ env.SEMERU_VERSION }}+8-jre/
        ```
        EOF

    # üîü Test package with ops (minimal)
    - name: Test package with ops
      if: false
      run: |
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}
        ops pkg add . -n ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}
        ops pkg load ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}

    - name: Create tarball and checksum
      run: |
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}
        tar czf ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz sysroot package.manifest README.md
        sha256sum ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz > ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz.sha256
        cat ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz.sha256


    # 13Ô∏è‚É£ Upload artifact
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}
        path: |
          ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz
          ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz.sha256
        retention-days: 30
