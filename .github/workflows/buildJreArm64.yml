name: Build Semeru JRE Nanos Package ARM64

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  SEMERU_VERSION: "25.0.1"
  OPENJ9_VERSION: "0.56.0"
  PACKAGE_NAME: "SemeruJDKarm64Linux"

jobs:
  build-arm64-package:
    runs-on: ubuntu-22.04
    
    steps:
    # 1Ô∏è‚É£ Checkout repo
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Install QEMU user-mode + Docker buildx
    - name: Install QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu qemu-user qemu-user-static

    - name: Install system utilities
      run: |
        sudo apt-get install -y qemu-system unzip wget tar

    # 3Ô∏è‚É£ Install ops CLI
    - name: Install ops (NanoVMs)
      run: |
        curl -L https://ops.city/get.sh | sh

    - name: Add ops to PATH
      run: |
        echo "$HOME/.ops/bin" >> $GITHUB_PATH

    - name: Verify ops installation
      run: |
        ops version

    # 4Ô∏è‚É£ Create package structure
    - name: Create package structure
      run: |
        mkdir -p ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/sysroot/usr/lib/aarch64-linux-gnu
        mkdir -p ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/sysroot/lib64
        echo "Package structure created"

    # 5Ô∏è‚É£ Download IBM Semeru JRE ARM64
    - name: Download Semeru JRE ARM64
      run: |
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/sysroot
        wget -q --show-progress \
          https://github.com/ibmruntimes/semeru25-binaries/releases/download/jdk-${{ env.SEMERU_VERSION }}%2B8_openj9-${{ env.OPENJ9_VERSION }}/ibm-semeru-open-jdk_aarch64_linux_${{ env.SEMERU_VERSION }}_8_openj9-${{ env.OPENJ9_VERSION }}.tar.gz
        tar xzf ibm-semeru-open-jdk_aarch64_linux_${{ env.SEMERU_VERSION }}_8_openj9-${{ env.OPENJ9_VERSION }}.tar.gz
        rm ibm-semeru-open-jdk_aarch64_linux_${{ env.SEMERU_VERSION }}_8_openj9-${{ env.OPENJ9_VERSION }}.tar.gz

    # 6Ô∏è‚É£ Extract ARM64 system libraries + linker via ARM64 container
    - name: Extract ARM64 system libraries
      run: |
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/sysroot
        docker run --rm --platform linux/arm64 -v $(pwd):/work ubuntu:22.04 bash -c "
          set -e
          apt-get update -qq
          apt-get install -y -qq libc6 libstdc++6 zlib1g
          
          mkdir -p /work/lib64 /work/usr/lib/aarch64-linux-gnu
          cp /lib/ld-linux-aarch64.so.1 /work/lib64/
          cp /lib/aarch64-linux-gnu/libc.so.6 /work/usr/lib/aarch64-linux-gnu/
          cp /lib/aarch64-linux-gnu/libm.so.6 /work/usr/lib/aarch64-linux-gnu/
          cp /lib/aarch64-linux-gnu/libpthread.so.0 /work/usr/lib/aarch64-linux-gnu/
          cp /lib/aarch64-linux-gnu/libdl.so.2 /work/usr/lib/aarch64-linux-gnu/
          cp /lib/aarch64-linux-gnu/librt.so.1 /work/usr/lib/aarch64-linux-gnu/
          cp /lib/aarch64-linux-gnu/libgcc_s.so.1 /work/usr/lib/aarch64-linux-gnu/
          cp /usr/lib/aarch64-linux-gnu/libstdc++.so.6 /work/usr/lib/aarch64-linux-gnu/
          cp /usr/lib/aarch64-linux-gnu/libz.so.1 /work/usr/lib/aarch64-linux-gnu/
        "

    # 7Ô∏è‚É£ Verify package structure
    - name: Verify package structure
      run: |
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/sysroot
        tree -L 3 || find . -type f | head -50

    # 8Ô∏è‚É£ Test package with ops (minimal)
    - name: Test package with ops
      run: |
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}/sysroot
        ops pkg add . -n ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}
        ops run java -version

    # 9Ô∏è‚É£ Create tarball
    - name: Create tarball
      run: |
        cd ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}
        tar czf ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz sysroot
        ls -lh ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz

    # üîü Generate checksum
    - name: Generate checksums
      run: |
        sha256sum ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz > ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz.sha256
        cat ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz.sha256

    # 11Ô∏è‚É£ Upload artifacts
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}
        path: |
          ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz
          ${{ env.PACKAGE_NAME }}_${{ env.SEMERU_VERSION }}.tar.gz.sha256
        retention-days: 30
