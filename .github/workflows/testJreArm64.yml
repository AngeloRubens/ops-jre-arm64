name: Test ops pkg ARM64 (QEMU apt)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-arm64:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Installazione classica QEMU + binfmt
      - name: Install QEMU ARM64 (apt)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-arm \
            qemu-system-aarch64 \
            qemu-user-static \
            binfmt-support

          qemu-aarch64-static --version

      # Abilita binfmt per ARM64
      - name: Enable binfmt for ARM64
        run: |
          sudo update-binfmts --enable qemu-aarch64
          update-binfmts --display qemu-aarch64

      # Install ops (NanoVMs)
      - name: Install ops
        run: |
          curl -fsSL https://ops.city/get.sh | sh
          sudo mv ops /usr/local/bin/ops
          ops version

      # Scarica il package ARM64
      - name: Download ops package (ARM64)
        run: |
          ops pkg get AngeloRubens/TemurinJREarm64Linux:25.0.1 --arch arm64

      # Carica ed esegue il package sotto emulazione ARM64
      - name: Load ops package (ARM64 via QEMU)
        run: |
          ops pkg load AngeloRubens/TemurinJREarm64Linux:25.0.1 --arch arm64
