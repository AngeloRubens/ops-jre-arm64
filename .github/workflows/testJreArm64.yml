name: Test ARM64 ops pkg via QEMU (full)


on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-arm64-qemu:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Verify preinstalled Java
        run: |
          echo "Checking Java runtime..."
          java -version || echo "Java not found"
          javac -version || echo "Javac not found"
          echo "JAVA_HOME is set to: $JAVA_HOME"

      - name: Download and test Temurin JRE 25
        run: |
          # Scarica la JRE
          wget https://github.com/ibmruntimes/semeru25-binaries/releases/download/jdk-25.0.1%2B8_openj9-0.56.0/ibm-semeru-open-jdk_aarch64_linux_25.0.1_8_openj9-0.56.0.tar.gz
          # Estrai l'archivio
          tar -xzf ibm-semeru-open-jdk_aarch64_linux_25.0.1_8_openj9-0.56.0.tar.gz
          
          # Trova la directory estratta (di solito jdk-25.0.1+8-jre)
          JRE_DIR=$(find . -maxdepth 1 -type d -name "jdk-*-jre" | head -n 1)
          echo "JRE directory: $JRE_DIR"
          
          # Imposta JAVA_HOME e PATH
          export JAVA_HOME="$PWD/$JRE_DIR"
          export PATH="$JAVA_HOME/bin:$PATH"
          
          # Testa java -version
          echo "Testing Java version..."
          java -version
    


 

      # Install QEMU user-mode + system emulation + utilities
      - name: Install QEMU and utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system qemu-user qemu-user-static qemu-system-arm qemu-system-aarch64 binfmt-support wget tar gzip


          # Ensure qemu-aarch64-static is in PATH for Ops
          sudo ln -sf $(which qemu-aarch64-static) /usr/local/bin/qemu-aarch64

          echo "QEMU versions installed:"
          qemu-aarch64 --version
          qemu-system-aarch64 --version

     

      # Install ops (ARM64 capable) as default
      - name: Install ops
        run: |
          curl https://ops.city/get.sh -sSfL | sh
          
          
      - name: Add ops to PATH
        run: |
          echo "$HOME/.ops/bin" >> $GITHUB_PATH
      # Step separato: check ops version
      - name: Check Ops version
        run: ops version


          



      # Download ops package ARM64
      - name: Download ops package ARM64
        run: |
          ops pkg get AngeloRubens/TemurinJREarm64Linux:25.0.1 --arch arm64 --nightly
      - name: Create Ops config.json with 2GB root volume
        run: |
          mkdir -p ~/.ops/images
          cat > ~/.ops/images/java-config.json <<EOF
          {
            "BaseVolumeSz": "1g",
            "Args": ["java","-version"]
          }
          EOF
          echo "Generated config.json:"
          cat ~/.ops/images/java-config.json    

      - name: Run OPS and capture all output
        id: ops_run
        continue-on-error: true
        run: |
          echo "=== Starting OPS execution with full logging ==="
          date
          
          # Esegui OPS e salva tutto l'output
          ops pkg load AngeloRubens/TemurinJREarm64Linux:25.0.1 \
            --arch arm64 \
            -c ~/.ops/images/java-config.json \
            --nightly \
            --verbose > ops_output.log 2>&1
          
          # Salva exit code
          echo $? > ops_exit_code.txt
          
          echo "=== OPS execution finished ==="
          date
          
          # Mostra le ultime righe del log
          echo ""
          echo "Last 50 lines of output:"
          tail -50 ops_output.log
      
      - name: Collect all crash artifacts
        if: always()
        run: |
          echo "=== Collecting crash artifacts ==="
          
          # Lista tutti i file nella directory corrente
          echo "Files in current directory:"
          ls -lah
          
          # Cerca JVM error reports (possono essere in / o nella directory corrente)
          echo ""
          echo "Looking for JVM error reports..."
          find . -name "hs_err_pid*.log" -o -name "hs_err_*.log" 2>/dev/null || true
          
          # Copia JVM error reports se esistono
          if ls hs_err_pid*.log 1> /dev/null 2>&1; then
            echo "âœ… Found JVM error report(s)"
            for file in hs_err_pid*.log; do
              echo "Found: $file ($(wc -l < $file) lines)"
            done
          else
            echo "âš ï¸ No hs_err_pid*.log found in current directory"
          fi
          
          # Cerca anche in root (il log dice //hs_err_pid2.log)
          if [ -f /hs_err_pid2.log ]; then
            echo "âœ… Found JVM error report in root"
            cp /hs_err_pid2.log ./hs_err_pid2_from_root.log
          fi
          
          # Cerca core dumps
          echo ""
          echo "Looking for core dumps..."
          if ls core.* 1> /dev/null 2>&1; then
            echo "âœ… Found core dump(s)"
            for core in core.*; do
              ls -lh "$core"
              echo "$core info:" > "${core}_info.txt"
              file "$core" >> "${core}_info.txt" 2>&1 || true
            done
          else
            echo "âš ï¸ No core dumps found (this is normal if core dumps are disabled)"
          fi
          
          # Cerca anche in root
          if [ -f /core.2 ]; then
            echo "âœ… Found core dump in root"
            cp /core.2 ./core.2_from_root
            ls -lh ./core.2_from_root
          fi
          
          # Controlla se ci sono altri log di OPS
          if [ -d ~/.ops/logs ]; then
            echo ""
            echo "âœ… Found OPS internal logs"
            ls -lah ~/.ops/logs/
            mkdir -p ops_internal_logs
            cp -r ~/.ops/logs/* ops_internal_logs/ 2>/dev/null || true
          fi
          
          # Crea un summary dettagliato
          cat > collection_summary.txt << 'EOF'
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CRASH ARTIFACTS COLLECTION SUMMARY
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
          
          echo "Collection Date: $(date)" >> collection_summary.txt
          echo "Exit Code: $(cat ops_exit_code.txt 2>/dev/null || echo 'unknown')" >> collection_summary.txt
          echo "" >> collection_summary.txt
          
          echo "--- Main Output Log ---" >> collection_summary.txt
          if [ -f ops_output.log ]; then
            echo "âœ… ops_output.log: $(wc -l < ops_output.log) lines" >> collection_summary.txt
          else
            echo "âŒ ops_output.log: NOT FOUND" >> collection_summary.txt
          fi
          echo "" >> collection_summary.txt
          
          echo "--- JVM Error Reports ---" >> collection_summary.txt
          if ls hs_err_*.log 1> /dev/null 2>&1; then
            for file in hs_err_*.log; do
              echo "âœ… $file: $(wc -l < $file) lines" >> collection_summary.txt
            done
          else
            echo "âŒ No JVM error reports found" >> collection_summary.txt
          fi
          echo "" >> collection_summary.txt
          
          echo "--- Core Dumps ---" >> collection_summary.txt
          if ls core.* 1> /dev/null 2>&1; then
            for core in core.*; do
              echo "âœ… $core: $(ls -lh $core | awk '{print $5}')" >> collection_summary.txt
            done
          else
            echo "âŒ No core dumps found" >> collection_summary.txt
          fi
          echo "" >> collection_summary.txt
          
          # Estrai l'errore principale dal log
          echo "--- Error Excerpt ---" >> collection_summary.txt
          if [ -f ops_output.log ]; then
            echo "Last error messages:" >> collection_summary.txt
            grep -A 10 "fatal error" ops_output.log | tail -20 >> collection_summary.txt 2>/dev/null || \
            grep -A 10 "Internal Error" ops_output.log | tail -20 >> collection_summary.txt 2>/dev/null || \
            echo "No specific error pattern found" >> collection_summary.txt
          fi
          
          echo "" >> collection_summary.txt
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> collection_summary.txt
          
          # Mostra il summary
          cat collection_summary.txt
      
      - name: Extract key error information
        if: always()
        run: |
          echo "=== Extracting key error information ==="
          
          # Se esiste l'error report della JVM, estrai le info principali
          if ls hs_err_*.log 1> /dev/null 2>&1; then
            echo "Creating error_details.txt from JVM crash report..."
            
            cat > error_details.txt << 'EOF'
          JVM CRASH ANALYSIS
          ==================
          EOF
            
            for hs_file in hs_err_*.log; do
              echo "" >> error_details.txt
              echo "From: $hs_file" >> error_details.txt
              echo "---" >> error_details.txt
              
              # Estrai la sezione dell'errore
              sed -n '/# A fatal error/,/# Core dump/p' "$hs_file" >> error_details.txt 2>/dev/null || true
              
              # Estrai anche la sezione VM info
              echo "" >> error_details.txt
              echo "VM Information:" >> error_details.txt
              sed -n '/# JRE version:/,/# Problematic frame:/p' "$hs_file" >> error_details.txt 2>/dev/null || true
            done
            
            cat error_details.txt
          fi
      
      - name: Upload all artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ops-crash-artifacts-${{ github.run_number }}
          path: |
            ops_output.log
            ops_exit_code.txt
            hs_err_*.log
            core.*
            *_info.txt
            collection_summary.txt
            error_details.txt
            ops_internal_logs/
            ~/.ops/images/java-config.json
          retention-days: 30
          if-no-files-found: warn
      
      - name: Display summary in job
        if: always()
        run: |
          echo "### ðŸ“‹ OPS Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f collection_summary.txt ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat collection_summary.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Quick Error Preview" >> $GITHUB_STEP_SUMMARY
          
          if [ -f error_details.txt ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -30 error_details.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Download full artifacts for complete logs and crash dumps**" >> $GITHUB_STEP_SUMMARY
