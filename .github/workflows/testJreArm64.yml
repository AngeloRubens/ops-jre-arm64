name: Test ARM64 ops pkg via QEMU (full)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-arm64-qemu:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install QEMU user-mode + system emulation + utilities
      - name: Install QEMU and utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system qemu-user qemu-user-static qemu-system-arm qemu-system-aarch64 binfmt-support wget tar gzip


          # Ensure qemu-aarch64-static is in PATH for Ops
          sudo ln -sf $(which qemu-aarch64-static) /usr/local/bin/qemu-aarch64

          echo "QEMU versions installed:"
          qemu-aarch64 --version
          qemu-system-aarch64 --version

      # Verify binfmt for ARM64
      - name: Verify ARM64 binfmt
        run: |
          if [ -f /proc/sys/fs/binfmt_misc/qemu-aarch64 ]; then
            echo "ARM64 binfmt enabled"
          else
            echo "ARM64 binfmt NOT enabled"
            exit 1
          fi

      # Install ops (ARM64 capable) as default
      - name: Install ops
        run: |
          curl https://ops.city/get.sh -sSfL | sh
          
          
      - name: Add ops to PATH
        run: |
          echo "$HOME/.ops/bin" >> $GITHUB_PATH
      # Step separato: check ops version
      - name: Check Ops version
        run: ops version

      # Prepare Ops nightly ARM64 cache (per guida Graviton)
      - name: Prepare Ops nightly ARM64 cache
        run: |
          mkdir -p ~/.ops/nightly

          echo "Cleaning x86 artifacts from Ops cache"
          rm -rf ~/.ops/nightly/bootx64.efi ~/.ops/nightly/k* \
                 ~/.ops/nightly/mkfs ~/.ops/nightly/dump || true
          
          echo "Downloading Nanos nightly"
          curl -L https://storage.googleapis.com/nanos/release/nightly/nanos-nightly-linux-virt.tar.gz \
            -o /tmp/nanos-nightly.tar.gz
          
          echo "Extracting Nanos nightly into Ops cache"
          tar -xzf /tmp/nanos-nightly.tar.gz -C ~/.ops/nightly
          
          echo "Ops nightly cache content:"
          ls -lh ~/.ops/nightly


      # Download ops package ARM64
      - name: Download ops package ARM64
        run: |
          ops pkg get AngeloRubens/TemurinJREarm64Linux:25.0.1 --arch arm64

      # Load / boot package ARM64 via QEMU
      - name: Load ops package ARM64 via QEMU
        run: |
          ops pkg load AngeloRubens/TemurinJREarm64Linux:25.0.1 --arch arm64
