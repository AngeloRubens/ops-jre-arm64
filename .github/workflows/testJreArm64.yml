name: Test ARM64 ops pkg via QEMU (full)

on:
  workflow_dispatch:

jobs:
  test-arm64-qemu:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Verify preinstalled Java
        run: |
          echo "Checking Java runtime..."
          java -version || echo "Java not found"
          javac -version || echo "Javac not found"
          echo "JAVA_HOME is set to: $JAVA_HOME"

      # Install QEMU user-mode + system emulation + utilities
      - name: Install QEMU and utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system qemu-user qemu-user-static qemu-system-arm qemu-system-aarch64 binfmt-support wget tar gzip


          # Ensure qemu-aarch64-static is in PATH for Ops
          sudo ln -sf $(which qemu-aarch64-static) /usr/local/bin/qemu-aarch64

          echo "QEMU versions installed:"
          qemu-aarch64 --version
          qemu-system-aarch64 --version

     

      # Install ops (ARM64 capable) as default
      - name: Install ops
        run: |
          curl https://ops.city/get.sh -sSfL | sh
          
          
      - name: Add ops to PATH
        run: |
          echo "$HOME/.ops/bin" >> $GITHUB_PATH
      # Step separato: check ops version
      - name: Check Ops version
        run: ops version      

      - name: Run OPS and capture all output
        id: ops_run
        continue-on-error: true
        run: |
          echo "=== Starting OPS execution with full logging ==="
          date
          
          # Esegui OPS e salva tutto l'output
          ops pkg load AngeloRubens/TemurinJREarm64Linux:25.0.1 \
            --arch arm64 \
            -a -XshowSettings:properties \
            --nightly \
            --verbose 
          
      
      
