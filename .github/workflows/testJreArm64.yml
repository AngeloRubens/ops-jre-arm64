name: Test ARM64 ops pkg via QEMU (full)


on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-arm64-qemu:
    runs-on: ubuntu-22.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Verify preinstalled Java
        run: |
          echo "Checking Java runtime..."
          java -version || echo "Java not found"
          javac -version || echo "Javac not found"
          echo "JAVA_HOME is set to: $JAVA_HOME"

      - name: Download and test Temurin JRE 25
        run: |
          # Scarica la JRE
          wget https://github.com/adoptium/temurin25-binaries/releases/download/jdk-25.0.1%2B8/OpenJDK25U-jre_aarch64_linux_hotspot_25.0.1_8.tar.gz
          
          # Estrai l'archivio
          tar -xzf OpenJDK25U-jre_aarch64_linux_hotspot_25.0.1_8.tar.gz
          
          # Trova la directory estratta (di solito jdk-25.0.1+8-jre)
          JRE_DIR=$(find . -maxdepth 1 -type d -name "jdk-*-jre" | head -n 1)
          echo "JRE directory: $JRE_DIR"
          
          # Imposta JAVA_HOME e PATH
          export JAVA_HOME="$PWD/$JRE_DIR"
          export PATH="$JAVA_HOME/bin:$PATH"
          
          # Testa java -version
          echo "Testing Java version..."
          java -version
    


 

      # Install QEMU user-mode + system emulation + utilities
      - name: Install QEMU and utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system qemu-user qemu-user-static qemu-system-arm qemu-system-aarch64 binfmt-support wget tar gzip


          # Ensure qemu-aarch64-static is in PATH for Ops
          sudo ln -sf $(which qemu-aarch64-static) /usr/local/bin/qemu-aarch64

          echo "QEMU versions installed:"
          qemu-aarch64 --version
          qemu-system-aarch64 --version

     

      # Install ops (ARM64 capable) as default
      - name: Install ops
        run: |
          curl https://ops.city/get.sh -sSfL | sh
          
          
      - name: Add ops to PATH
        run: |
          echo "$HOME/.ops/bin" >> $GITHUB_PATH
      # Step separato: check ops version
      - name: Check Ops version
        run: ops version

      # Prepare Ops nightly ARM64 cache (per guida Graviton)
      - name: Prepare Ops ARM64 kernel (dynamic Nanos version)
        run: |
          set -e
      
          NANOS_VERSION=$(ops version | awk '/Nanos version:/ {print $3}')
          OPS_DIR="$HOME/.ops/${NANOS_VERSION}-arm"
      
          echo "Detected Nanos version: $NANOS_VERSION"
          echo "Using Ops directory: $OPS_DIR"
      
          mkdir -p "$OPS_DIR"
          rm -rf "$OPS_DIR"/*
      
          echo "Downloading Nanos ARM64 kernel bundle"
          curl -L https://storage.googleapis.com/nanos/release/nightly/nanos-nightly-linux-virt.tar.gz \
            -o /tmp/nanos-arm64.tar.gz
      
          echo "Extracting kernel into Ops directory"
          tar -xzf /tmp/nanos-arm64.tar.gz -C "$OPS_DIR"
      
          echo "Final Ops ARM64 layout:"
          ls -lh "$OPS_DIR"

          



      # Download ops package ARM64
      - name: Download ops package ARM64
        run: |
          ops pkg get AngeloRubens/TemurinJREarm64Linux:25.0.1 --arch arm64 --nightly
      - name: Create Ops config.json with 2GB root volume
        run: |
          mkdir -p ~/.ops/images
          cat > ~/.ops/images/java-config.json <<EOF
          {
            "BaseVolumeSz": "1g",
            "Args": ["java",
              "-XshowSettings",
              "-XX:+UnlockDiagnosticVMOptions",
              "-XX:-UseDCZVA"
            ]
          }
          EOF
          echo "Generated config.json:"
          cat ~/.ops/images/java-config.json    

      # Load / boot package ARM64 via QEMU
      - name: Load ops package ARM64 via QEMU
        run: |
          ops pkg load AngeloRubens/TemurinJREarm64Linux:25.0.1 --arch arm64 -c ~/.ops/images/java-config.json --nightly 
